<!DOCTYPE html>
<html lang="en">

<head>
</head>

<body>
  <link href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css" rel="stylesheet">
  <!-- Preloader-->
  <div class="page-loader">
    <div class="page-loader-inner">
      <div class="spinner">
        <div class="double-bounce1"></div>
        <div class="double-bounce2"></div>
      </div>
    </div>
  </div>
  <!-- Preloader end-->

  <!-- ●Header -->
  <header class="header header-transparent"></header>
  <!-- ●Header end -->

  <!-- Wrapper-->
  <div class="wrapper">
    <!-- Hero-->
    <section class="module-page-title parallax text-center" data-background="assets/images/module-8.jpg" data-overlay="0.5">
      <div class="container">
        <div class="row">
          <div class="col-md-12">
            <h1 class="m-b-20"><strong>Public notice</strong></h1>
            <p class="m-b-40">텔루스 게시판 관리자 화면입니다.<br></p>
          </div>
        </div>
      </div>
    </section>
    <!-- Hero end-->

    <!-- DataTable -->
    <section class="module">
      <div class="container">
        <div id="wrap-datatable" class="col-lg-12 col-md-12 m-auto text-center">
          <table id="datatable" class="ui celled table display" style="width:100%">
          </table>
        </div>
      </div>
  </div>
  </section>
  <div class="col-lg-12 col-md-12 m-auto text-center"></div>
  <!-- DataTable End -->

  <!-- ●Footer-->
  <footer class="footer"></footer>
  <!-- ●Footer end-->
  </div>
  <!-- Wrapper end-->

  <!-- ●Slide Bar -->
  <sidebar class="off-canvas-sidebar"></sidebar>
  <!-- ●Slide Bar End -->

  <!-- To top button-->
  <a class="scroll-top" href="#top"><i class="fas fa-angle-up"></i></a>
  <div id="my_popup" class="well">
    <div class="popup-editor-hidden">
      <input id="rowId" name="rowId" type="hidden"></input>
    </div>
    <div class="popup-editor-header">
      <input id="title" name="title" type="text" class="popup-editor-title"></input>
      <!-- <input id="checkbox" name="checkbox" type="checkbox" class="form-check-input" value=""> -->
    </div>
    <div class="popup-editor-body">
      <textarea id="editor" name="editor"></textarea>
      <div id="distfile">&nbsp;</div>
      <input id="fileupload" type="file" name="file">
    </div>
    <div class="popup-editor-footer">
      <button class="btn btn-brand btn-sm" onclick="uploadRow();">완료</button>
      <button class="btn btn-secondary btn-sm" onclick="closePopup();">취소</button>
    </div>
  </div>

  <!-- Scripts-->
  <!-- <script src="https://fullcalendar.io/releases/fullcalendar/3.9.0/lib/jquery.min.js"></script> -->
  <script src="../assets/js/custom/jquery-3.2.1.min.js"></script>
  <script src="../assets/js/custom/popper.min.js"></script>
  <script src="../assets/js/bootstrap/bootstrap.min.js"></script>
  <script src="../assets/js/custom/plugins.min.js"></script>
  <script src="../assets/js/custom/custom.min.js"></script>
  <script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-popup-overlay/1.7.9/jquery.popupoverlay.js"></script>
  <script src="https://cdn.datatables.net/select/1.2.6/js/dataTables.select.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/1.5.2/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.ckeditor.com/ckeditor5/10.1.0/classic/ckeditor.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script>
    let dataSet = []
    let ckEditor
    let table

    ClassicEditor
      .create(document.querySelector('#editor'), {
        toolbar: ['heading', '|', 'bold', 'italic', 'link', 'bulletedList', 'numberedList', 'blockQuote']
      })
      .then(editor => {
        ckEditor = editor
      })
      .catch(error => console.error(error))

    $(document).ready(function() {

      $("#fileupload").change(function() {
        const data = new FormData()
        data.append('file', document.getElementById('fileupload').files[0]);
        axios.put('/admin/upload', data).then(function(res) {
          if (ckEditor) {
            const fileName = res.data.filename
            const filePath = 'uploads/' + fileName
            ckEditor.setData(ckEditor.getData() + '<a href="' + filePath + '" target="_blank">' + fileName)
          }
          // $('#distfile').html('<a href="javascript:insertLink();">' + res.data.filename + '</a>')
        })
      })

      table = $('#datatable').DataTable({
        // data: dataSet,
        ordering: false,
        searching: false,
        // paging: false,
        bInfo: false,
        // select: true,
        ajax: {
          url: '/admin/board',
          dataSrc: function(json) {
            dataSet = json
            return json
          }
        },
        columns: [{
            title: "번호",
            width: "10%",
            fnCreatedCell: function(nTd, sData, oData, iRow, iCol) {
              if (oData[5] === 1) $(nTd).html("공지")
              else $(nTd).html(sData)
            }
          },
          {
            title: "제목",
            width: "50%",
          },
          {
            title: "작성자",
            width: "10%",
          },
          {
            title: "작성일",
            width: "10%"
          },
          {
            title: "수정",
            width: "5%",
            fnCreatedCell: function(nTd, sData, oData, iRow, iCol) {
              $(nTd).html("<button type='button' class='btn btn-brand btn-xs' onclick='editRow(" + iRow + ")'>수정</button>")
            }
          },
          {
            title: "삭제",
            width: "5%",
            fnCreatedCell: function(nTd, sData, oData, iRow, iCol) {
              $(nTd).html("<button type='button' class='btn btn-secondary btn-xs' onclick='deleteRow(" + iRow + ")'>삭제</button>")
            }
          }
        ],
      })
      $('#datatable').after('<button type="button" id="create" class="btn btn-brand btn-sm mt-1 float-left" onclick="createRow()">글쓰기</button>')
      $('#my_popup').popup({
        escape: false,
        blur: false,
        transition: 'all 0.5s'
      })

    })

    function closePopup(index) {
      $('#my_popup').popup('hide')
    }

    function editRow(index) {
      ckEditor.setData(dataSet[index][4])
      $('.popup-editor-title').val(dataSet[index][1])
      $('#rowId').val(dataSet[index][0])
      $('#my_popup').popup('show')
    }

    function createRow(index) {
      ckEditor.setData('')
      $('.popup-editor-title').val('')
      $('#my_popup').popup('show')
    }

    function deleteRow(index) {
      if (confirm("정말 삭제하시겠습니까??") == true) { //확인
        axios.post('/admin/board/delete', {
          sequence: dataSet[index][0]
        }).then(function(res) {
          if (table) table.ajax.reload()
          // alert('삭제 완료')
        }).catch(function(err) {
          alert(err)
        })
      } else {
        return;
      }
    }

    function uploadRow() {
      const data = {
        rowId: $('#rowId').val(),
        title: $('#title').val(),
        // type: $('#checkbox').val(),
        content: ckEditor.getData()
      }

      if (!data.title) {
        alert('제목을 입력하세요')
        return
      }

      axios.post('/admin/board', data).then(function(res) {
        console.log(res.data)
        if (table) table.ajax.reload()
        closePopup()
      }).catch(function(err) {
        console.log('err', err)
        alert(err)
      })
    }

    function insertLink(ckEditor) {
      const fileName = $('#distfile a').text()
      const filePath = 'uploads/' + fileName
      if (ckEditor) {
        ckEditor.setData(ckEditor.getData() + '<a href="' + filePath + '" target="_blank">' + fileName)
        //   ckEditor.model.change(writer => {
        //     const insertPosition = ckEditor.model.document.selection.getLastRange()
        //     writer.insertText(fileName, {
        //       linkHref: filePath
        //     }, insertPosition)
        //   })
      }
    }
  </script>
</body>

</html>